<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>好好報價</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/WrZbkYw.png">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
      font-size: 16px;
      position: relative;
    }
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      padding: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      color: #4A3C31;
      font-size: 1.5em;
      margin: 10px 0;
    }
    label {
      display: block;
      margin: 8px 0 4px;
      font-weight: bold;
      font-size: 0.9em;
    }
    select, input {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.9em;
      box-sizing: border-box;
    }
    .discount-container, .adjustment-container {
      margin-bottom: 8px;
    }
    .integer-discount-container, .integer-adjustment-container {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    .integer-discount-container select, .integer-adjustment-container select {
      width: 33%;
    }
    button {
      width: 100%;
      padding: 12px;
      background-color: #4A3C31;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 10px;
      touch-action: manipulation;
    }
    button:hover {
      background-color: #5A4C41;
    }
    .toggle-button {
      width: auto;
      padding: 5px 10px;
      font-size: 0.9em;
      margin-left: 10px;
      display: inline-block;
    }
    #quoteResult {
      margin-top: 15px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      font-size: 0.9em;
    }
    .hidden {
      display: none;
    }
    #dayType {
      margin-top: 5px;
      font-style: italic;
      color: #555;
      font-size: 0.85em;
      overflow-wrap: break-word;
    }
    #copyMessage {
      margin-top: 8px;
      color: green;
      font-style: italic;
      text-align: center;
      font-size: 0.85em;
    }
    #nightlyDiscounts, #nightlyTypes {
      margin-top: 8px;
    }
    #quoteTextArea {
      width: 100%;
      height: 80px;
      margin-top: 8px;
      display: none;
      font-size: 0.85em;
    }
    #nightlyBreakdown ul {
      padding-left: 20px;
      margin: 5px 0;
    }
    #nightlyBreakdown li {
      margin-bottom: 5px;
      font-size: 0.85em;
      overflow-wrap: break-word;
    }
    .img-top-right {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 200px;
    }
    @media (max-width: 600px) {
      body {
        padding: 5px;
        font-size: 14px;
      }
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.2em;
      }
      label {
        font-size: 0.85em;
      }
      select, input {
        padding: 8px;
        font-size: 0.85em;
      }
      .integer-discount-container select, .integer-adjustment-container select {
        padding: 8px;
        font-size: 0.85em;
      }
      button {
        padding: 10px;
        font-size: 0.9em;
      }
      #quoteResult {
        padding: 10px;
        font-size: 0.85em;
      }
      #dayType, #copyMessage, #quoteTextArea, #nightlyBreakdown li {
        font-size: 0.8em;
      }
      .img-top-right {
        width: 75px;
      }
    }
  </style>
</head>
<body>
  <img src="https://i.imgur.com/925OqUB.jpg" class="img-top-right" alt="民宿標誌">
  <div class="container">
    <h1>好好報價</h1>
    
    <label for="checkInDate">入住日期</label>
    <input type="date" id="checkInDate" onchange="updateCheckOutDate(); updateDayTypeAndRooms()">

    <label for="checkOutDate">退房日期</label>
    <input type="date" id="checkOutDate" onchange="updateDayTypeAndRooms()">

    <label for="dayTypeMode">日期類型設定</label>
    <select id="dayTypeMode" onchange="updateDayTypeAndRooms()">
      <option value="auto">自動偵測</option>
      <option value="manual">手動設定</option>
    </select>

    <div id="dayType"></div>
    <div id="nightlyTypes"></div>

    <label for="roomType">選擇房型</label>
    <select id="roomType" onchange="updatePrice()"></select>

    <label for="addBreakfast">加床數（每人每晚 1000元/床，上限4床）</label>
    <select id="addBreakfast" onchange="updatePrice()">
      <option value="0">0 床</option>
      <option value="1">1 床</option>
      <option value="2">2 床</option>
      <option value="3">3 床</option>
      <option value="4">4 床</option>
    </select>

    <div class="adjustment-container">
      <label style="display: inline;">暑假調漲模式（7月1日-8月31日）
        <button class="toggle-button" onclick="toggleSection('summerPeakAdjustmentSection')">+</button>
      </label>
      <div id="summerPeakAdjustmentSection" class="hidden">
        <select id="summerPeakAdjustmentMode" onchange="updateSummerPeakAdjustmentInput()">
          <option value="percentage">比例模式</option>
          <option value="integer">整數模式</option>
        </select>
        <div id="summerPeakAdjustmentInput"></div>
      </div>
    </div>

    <div class="adjustment-container">
      <label style="display: inline;">春節調漲模式（除夕至初三）
        <button class="toggle-button" onclick="toggleSection('springFestivalAdjustmentSection')">+</button>
      </label>
      <div id="springFestivalAdjustmentSection" class="hidden">
        <select id="springFestivalAdjustmentMode" onchange="updateSpringFestivalAdjustmentInput()">
          <option value="percentage">比例模式</option>
          <option value="integer">整數模式</option>
        </select>
        <div id="springFestivalAdjustmentInput"></div>
      </div>
    </div>

    <div class="discount-container">
      <label style="display: inline;">總價打折數
        <button class="toggle-button" onclick="toggleSection('totalDiscountSection')">+</button>
      </label>
      <div id="totalDiscountSection" class="hidden">
        <select id="totalDiscount" onchange="updatePrice()">
          <option value="1.0">無折扣</option>
          <option value="0.95">95折</option>
          <option value="0.9">9折</option>
          <option value="0.85">85折</option>
          <option value="0.8">8折</option>
        </select>
      </div>
    </div>

    <label for="discountMode">折扣模式</label>
    <select id="discountMode" onchange="updateDayTypeAndRooms()">
      <option value="percentage">比例模式</option>
      <option value="integer">整數模式</option>
      <option value="mixed">混合模式</option>
    </select>

    <div id="nightlyDiscounts"></div>

    <button onclick="generateQuote()">生成報價單</button>

    <div id="quoteResult" class="hidden">
      <p><strong>入住日期：</strong><span id="quoteCheckInDate"></span></p>
      <p><strong>退房日期：</strong><span id="quoteCheckOutDate"></span></p>
      <p><strong>日期類型：</strong><span id="quoteDayType"></span></p>
      <p><strong>房型：</strong><span id="quoteRoomType"></span></p>
      <p><strong>入住人數：</strong><span id="quoteNumPeople"></span> 人</p>
      <p><strong>入住天數：</strong><span id="quoteNumNights"></span> 晚</p>
      <p id="quoteSummerPeakAdjustmentRow" class="hidden"><strong>暑假調漲：</strong><span id="quoteSummerPeakAdjustment"></span></p>
      <p id="quoteSpringFestivalAdjustmentRow" class="hidden"><strong>春節調漲：</strong><span id="quoteSpringFestivalAdjustment"></span></p>
      <div id="nightlyBreakdown"></div>
      <p id="quoteAddBreakfastRow" class="hidden"><strong>加床費用：</strong>NT$ <span id="quoteAddBreakfast"></span></p>
      <p id="quoteTotalDiscountRow" class="hidden"><strong>總價折扣：</strong><span id="quoteTotalDiscount"></span></p>
      <p><strong>總金額：</strong>NT$ <span id="quoteTotal"></span>；訂金(50%)：NT$ <span id="quoteDeposit"></span></p>
      <button onclick="copyQuote()">複製報價單內容</button>
      <div id="copyMessage" class="hidden"></div>
      <textarea id="quoteTextArea" readonly></textarea>
    </div>
  </div>

  <script>
    /* 平日價格 */
    const basePrices = {
      "四人微包棟": { weekday: 9800, people: 4 },
      "六人微包棟": { weekday: 11800, people: 6 },
      "八人小包棟": { weekday: 15800, people: 8 },
      "十人中包棟": { weekday: 17800, people: 10 },
      "十二人大包棟": { weekday: 20800, people: 12 }
    };

    /* 房型顯示名稱 */
    const roomTypeDisplay = {
      "四人微包棟": "四人微包棟(雙人房*2 或 四人房*1)",
      "六人微包棟": "六人微包棟(雙人房*1、四人房*1)",
      "八人小包棟": "八人小包棟(雙人房*2、四人房*1 或 四人房*2)",
      "十人中包棟": "十人中包棟(雙人房*1、四人房*2)",
      "十二人大包棟": "十二人大包棟(雙人房*2、四人房*2)"
    };
     /* 春節期間 */
    const springFestivalPeriods = [
      { start: new Date("2025-01-25"), end: new Date("2025-02-02") },
      { start: new Date("2026-02-14"), end: new Date("2026-02-22") },
      { start: new Date("2027-02-04"), end: new Date("2027-02-12") }
    ];
     /* 除夕至初三 */
    const springFestivalEveToThirdDay = [
      { start: new Date("2025-01-28"), end: new Date("2025-01-31") },
      { start: new Date("2026-02-16"), end: new Date("2026-02-19") },
      { start: new Date("2027-02-05"), end: new Date("2027-02-08") }
    ];
     /* 國定假日 */
    const nationalHolidays = [
      new Date("2025-01-01"),
      new Date("2025-02-28"), new Date("2025-03-01"), new Date("2025-03-02"),
      new Date("2025-04-03"), new Date("2025-04-04"), new Date("2025-04-05"), new Date("2025-04-06"),
      new Date("2025-05-01"),
      new Date("2025-05-30"), new Date("2025-05-31"), new Date("2025-06-01"), new Date("2025-09-28"),
      new Date("2025-10-04"), new Date("2025-10-05"), new Date("2025-10-06"),
      new Date("2025-10-10"), new Date("2025-10-11"), new Date("2025-10-12"),
      new Date("2025-10-25"),
      new Date("2025-12-25"),
      new Date("2026-01-01"), new Date("2026-02-15"),
      new Date("2026-02-27"), new Date("2026-02-28"), new Date("2026-03-01"),
      new Date("2026-04-03"), new Date("2026-04-04"), new Date("2026-04-05"),
      new Date("2026-05-01"),
      new Date("2026-06-18"), new Date("2026-06-19"), new Date("2026-06-20"),
      new Date("2026-09-23"), new Date("2026-09-24"), new Date("2026-09-25"),
      new Date("2026-10-09"), new Date("2026-10-10"), new Date("2026-10-11"),
      new Date("2027-01-01"),
      new Date("2027-02-27"), new Date("2027-02-28"), new Date("2027-03-01"),
      new Date("2027-04-03"), new Date("2027-04-04"), new Date("2027-04-05"),
      new Date("2027-05-01"),
      new Date("2027-06-07"), new Date("2027-06-08"), new Date("2027-06-09"),
      new Date("2027-09-12"), new Date("2027-09-13"), new Date("2027-09-14"),
      new Date("2027-10-09"), new Date("2027-10-10"), new Date("2027-10-11")
    ];

    function isSpringFestival(date) {
      return springFestivalPeriods.some(period => 
        date >= period.start && date <= period.end
      );
    }

    function isSpringFestivalEveToThirdDay(date) {
      return springFestivalEveToThirdDay.some(period => 
        date >= period.start && date <= period.end
      );
    }

    function isNationalHoliday(date) {
      return nationalHolidays.some(holiday => 
        holiday.getFullYear() === date.getFullYear() &&
        holiday.getMonth() === date.getMonth() &&
        holiday.getDate() === date.getDate()
      );
    }

    function isHoliday(date) {
      const day = date.getDay();
      return day === 5 || day === 6 || isSpringFestival(date) || isNationalHoliday(date);
    }

    function isSummerPeakSeason(date) {
      const month = date.getMonth();
      const day = date.getDate();
      return (month === 6 && day >= 1) || (month === 7 && day <= 31);
    }

    function calculateNights() {
      const checkIn = new Date(document.getElementById("checkInDate").value);
      const checkOut = new Date(document.getElementById("checkOutDate").value);
      if (checkIn && checkOut && checkOut > checkIn) {
        const diffTime = Math.abs(checkOut - checkIn);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }
      return 0;
    }

    function updateCheckOutDate() {
      const checkInDate = document.getElementById("checkInDate").value;
      const checkOutDate = document.getElementById("checkOutDate").value;
      if (checkInDate && !checkOutDate) {
        const checkIn = new Date(checkInDate);
        const nextDay = new Date(checkIn);
        nextDay.setDate(checkIn.getDate() + 1);
        const formattedNextDay = nextDay.toISOString().split('T')[0];
        document.getElementById("checkOutDate").value = formattedNextDay;
      }
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const button = section.previousElementSibling.querySelector('.toggle-button');
      if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        button.textContent = '−';
      } else {
        section.classList.add('hidden');
        button.textContent = '+';
      }
      updatePrice();
    }

    function updateDayTypeAndRooms() {
      const checkIn = new Date(document.getElementById("checkInDate").value);
      const checkOut = new Date(document.getElementById("checkOutDate").value);
      const dayTypeMode = document.getElementById("dayTypeMode").value;
      const discountMode = document.getElementById("discountMode").value;
      const roomTypeSelect = document.getElementById("roomType");
      const dayTypeDiv = document.getElementById("dayType");
      const nightlyTypesDiv = document.getElementById("nightlyTypes");
      const nightlyDiscountsDiv = document.getElementById("nightlyDiscounts");

      const dayNames = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];

      if (!checkIn || !checkOut) {
        dayTypeDiv.textContent = "";
        roomTypeSelect.innerHTML = '<option value="">請選擇日期</option>';
        nightlyTypesDiv.innerHTML = "";
        nightlyDiscountsDiv.innerHTML = "";
        return;
      }

      const numNights = calculateNights();
      let currentDate = new Date(checkIn);
      let nightCount = 0;
      let dayTypeText = "";
      let nightTypes = [];

      nightlyTypesDiv.innerHTML = "";
      const typesFragment = document.createDocumentFragment();
      if (dayTypeMode === "manual") {
        for (let i = 1; i <= numNights; i++) {
          const label = document.createElement("label");
          label.setAttribute("for", `nightType${i}`);
          label.textContent = `第${i}晚類型`;
          const select = document.createElement("select");
          select.setAttribute("id", `nightType${i}`);
          select.setAttribute("onchange", "updatePrice()");
          select.innerHTML = `
            <option value="weekday">平日</option>
            <option value="holiday">假日</option>
            <option value="nationalHoliday">國定假日</option>
          `;
          typesFragment.appendChild(label);
          typesFragment.appendChild(select);
        }
      }
      nightlyTypesDiv.appendChild(typesFragment);

      while (currentDate < checkOut) {
        nightCount++;
        let isHolidayNight;
        let nightType;

        if (dayTypeMode === "auto") {
          isHolidayNight = isHoliday(currentDate);
          nightType = isHolidayNight ? (isNationalHoliday(currentDate) ? "nationalHoliday" : "holiday") : "weekday";
        } else {
          nightType = document.getElementById(`nightType${nightCount}`)?.value || "weekday";
          isHolidayNight = nightType === "holiday" || nightType === "nationalHoliday";
        }

        nightTypes.push({ night: nightCount, type: nightType });
        const dayName = dayNames[currentDate.getDay()];
        dayTypeText += `第${nightCount}晚：${nightType === "weekday" ? `平日(${dayName})` : nightType === "holiday" ? `假日(${dayName})` : `國定假日(${dayName})`}`;
        if (nightCount < numNights) dayTypeText += "，";
        currentDate.setDate(currentDate.getDate() + 1);
      }
      dayTypeText += `，共${numNights}晚`;
      dayTypeDiv.textContent = `日期類型：${dayTypeText}`;

      const isHolidayFirstNight = nightTypes[0]?.type === "holiday" || nightTypes[0]?.type === "nationalHoliday";
      const currentRoomType = roomTypeSelect.value;
      roomTypeSelect.innerHTML = "";
      if (isHolidayFirstNight) {
        roomTypeSelect.innerHTML = '<option value="十二人大包棟">十二人大包棟(雙人房*2、四人房*2)</option>';
        roomTypeSelect.value = "十二人大包棟";
      } else {
        roomTypeSelect.innerHTML = `
          <option value="四人微包棟">四人微包棟(雙人房*2 或 四人房*1)</option>
          <option value="六人微包棟">六人微包棟(雙人房*1、四人房*1)</option>
          <option value="八人小包棟">八人小包棟(雙人房*2、四人房*1)</option>
          <option value="十人中包棟">十人中包棟(雙人房*1、四人房*2)</option>
          <option value="十二人大包棟">十二人大包棟(雙人房*2、四人房*2)</option>
        `;
        roomTypeSelect.value = currentRoomType && basePrices[currentRoomType] ? currentRoomType : "四人微包棟";
      }

      nightlyDiscountsDiv.innerHTML = "";
      const discountsFragment = document.createDocumentFragment();
      for (let i = 1; i <= numNights; i++) {
        const container = document.createElement("div");
        container.className = "discount-container";
        const label = document.createElement("label");
        label.textContent = `第${i}晚折扣`;
        container.appendChild(label);

        if (discountMode === "mixed") {
          const modeSelect = document.createElement("select");
          modeSelect.setAttribute("id", `discountModeNight${i}`);
          modeSelect.setAttribute("onchange", `updateDiscountInput(${i}); updatePrice()`);
          modeSelect.innerHTML = `
            <option value="percentage">比例模式</option>
            <option value="integer">整數模式</option>
          `;
          container.appendChild(modeSelect);
        }

        const discountInputDiv = document.createElement("div");
        discountInputDiv.setAttribute("id", `discountInputNight${i}`);
        container.appendChild(discountInputDiv);

        discountsFragment.appendChild(container);
      }
      nightlyDiscountsDiv.appendChild(discountsFragment);

      requestAnimationFrame(() => {
        for (let i = 1; i <= numNights; i++) {
          updateDiscountInput(i);
        }
      });

      updateSummerPeakAdjustmentInput();
      updateSpringFestivalAdjustmentInput();
      updatePrice();
    }

    function updateDiscountInput(night) {
      const discountMode = document.getElementById("discountMode").value;
      const nightModeElement = document.getElementById(`discountModeNight${night}`);
      const nightMode = discountMode === "mixed" && nightModeElement ? nightModeElement.value : discountMode;
      const discountInputDiv = document.getElementById(`discountInputNight${night}`);
      if (!discountInputDiv) return;

      discountInputDiv.innerHTML = "";

      if (nightMode === "percentage") {
        const select = document.createElement("select");
        select.setAttribute("id", `discountNight${night}`);
        select.setAttribute("onchange", "updatePrice()");
        select.innerHTML = `
          <option value="1.0">無折扣</option>
          <option value="0.95">95折</option>
          <option value="0.9">9折</option>
          <option value="0.85">85折</option>
          <option value="0.8">8折</option>
          <option value="0.75">75折</option>
          <option value="0.7">7折</option>
          <option value="0.65">65折價</option>
          <option value="0.55">55折價</option>
          <option value="0.5">5折</option>
        `;
        discountInputDiv.appendChild(select);
      } else {
        const container = document.createElement("div");
        container.className = "integer-discount-container";

        const wanSelect = document.createElement("select");
        wanSelect.setAttribute("id", `discountNight${night}_wan`);
        wanSelect.setAttribute("onchange", "updatePrice()");
        wanSelect.innerHTML = Array.from({ length: 6 }, (_, idx) => `<option value="${idx}">${idx}萬</option>`).join('');
        container.appendChild(wanSelect);

        const qianSelect = document.createElement("select");
        qianSelect.setAttribute("id", `discountNight${night}_qian`);
        qianSelect.setAttribute("onchange", "updatePrice()");
        qianSelect.innerHTML = Array.from({ length: 10 }, (_, idx) => `<option value="${idx}">${idx}千</option>`).join('');
        container.appendChild(qianSelect);

        const baiSelect = document.createElement("select");
        baiSelect.setAttribute("id", `discountNight${night}_bai`);
        baiSelect.setAttribute("onchange", "updatePrice()");
        baiSelect.innerHTML = Array.from({ length: 10 }, (_, idx) => `<option value="${idx}">${idx}百</option>`).join('');
        container.appendChild(baiSelect);

        discountInputDiv.appendChild(container);
      }
    }

    function updateSummerPeakAdjustmentInput() {
      const mode = document.getElementById("summerPeakAdjustmentMode")?.value || "percentage";
      const inputDiv = document.getElementById("summerPeakAdjustmentInput");
      if (!inputDiv) return;
      inputDiv.innerHTML = "";

      if (mode === "percentage") {
        const select = document.createElement("select");
        select.setAttribute("id", "summerPeakAdjustment");
        select.setAttribute("onchange", "updatePrice()");
        select.innerHTML = `
          <option value="1.0">無調漲</option>
          <option value="1.1">調漲1成</option>
          <option value="1.2">調漲2成</option>
          <option value="1.3">調漲3成</option>
          <option value="1.4">調漲4成</option>
          <option value="1.5">調漲5成</option>
        `;
        inputDiv.appendChild(select);
      } else {
        const container = document.createElement("div");
        container.className = "integer-adjustment-container";

        const wanSelect = document.createElement("select");
        wanSelect.setAttribute("id", "summerPeakAdjustment_wan");
        wanSelect.setAttribute("onchange", "updatePrice()");
        wanSelect.innerHTML = Array.from({ length: 6 }, (_, idx) => `<option value="${idx}">${idx}萬</option>`).join('');
        container.appendChild(wanSelect);

        const qianSelect = document.createElement("select");
        qianSelect.setAttribute("id", "summerPeakAdjustment_qian");
        qianSelect.setAttribute("onchange", "updatePrice()");
        qianSelect.innerHTML = Array.from({ length: 10 }, (_, idx) => `<option value="${idx}">${idx}千</option>`).join('');
        container.appendChild(qianSelect);

        const baiSelect = document.createElement("select");
        baiSelect.setAttribute("id", "summerPeakAdjustment_bai");
        baiSelect.setAttribute("onchange", "updatePrice()");
        baiSelect.innerHTML = Array.from({ length: 10 }, (_, idx) => `<option value="${idx}">${idx}百</option>`).join('');
        container.appendChild(baiSelect);

        inputDiv.appendChild(container);
      }
    }

    function updateSpringFestivalAdjustmentInput() {
      const mode = document.getElementById("springFestivalAdjustmentMode")?.value || "percentage";
      const inputDiv = document.getElementById("springFestivalAdjustmentInput");
      if (!inputDiv) return;
      inputDiv.innerHTML = "";

      if (mode === "percentage") {
        const select = document.createElement("select");
        select.setAttribute("id", "springFestivalAdjustment");
        select.setAttribute("onchange", "updatePrice()");
        select.innerHTML = `
          <option value="1.0">無調漲</option>
          <option value="1.1">調漲1成</option>
          <option value="1.2">調漲2成</option>
          <option value="1.3">調漲3成</option>
        `;
        inputDiv.appendChild(select);
      } else {
        const container = document.createElement("div");
        container.className = "integer-adjustment-container";

        const wanSelect = document.createElement("select");
        wanSelect.setAttribute("id", "springFestivalAdjustment_wan");
        wanSelect.setAttribute("onchange", "updatePrice()");
        wanSelect.innerHTML = Array.from({ length: 6 }, (_, idx) => `<option value="${idx}">${idx}萬</option>`).join('');
        container.appendChild(wanSelect);

        const qianSelect = document.createElement("select");
        qianSelect.setAttribute("id", "springFestivalAdjustment_qian");
        qianSelect.setAttribute("onchange", "updatePrice()");
        qianSelect.innerHTML = Array.from({ length: 10 }, (_, idx) => `<option value="${idx}">${idx}千</option>`).join('');
        container.appendChild(qianSelect);

        const baiSelect = document.createElement("select");
        baiSelect.setAttribute("id", "springFestivalAdjustment_bai");
        baiSelect.setAttribute("onchange", "updatePrice()");
        baiSelect.innerHTML = Array.from({ length: 10 }, (_, idx) => `<option value="${idx}">${idx}百</option>`).join('');
        container.appendChild(baiSelect);

        inputDiv.appendChild(container);
      }
    }

    function calculatePricePerNight() {
      const checkIn = new Date(document.getElementById("checkInDate").value);
      const checkOut = new Date(document.getElementById("checkOutDate").value);
      const dayTypeMode = document.getElementById("dayTypeMode").value;
      const discountMode = document.getElementById("discountMode").value;
      const roomType = document.getElementById("roomType").value;
      const addBreakfast = parseInt(document.getElementById("addBreakfast").value);
      const summerPeakAdjustmentMode = document.getElementById("summerPeakAdjustmentMode")?.value || "percentage";
      const springFestivalAdjustmentMode = document.getElementById("springFestivalAdjustmentMode")?.value || "percentage";
      const totalDiscount = parseFloat(document.getElementById("totalDiscount")?.value || 1.0);
      const dayNames = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];

      let summerPeakAdjustment = 1.0;
      let summerPeakAdjustmentAmount = 0;
      let applySummerPeakAdjustmentAmount = false;
      if (document.getElementById("summerPeakAdjustmentSection")?.classList.contains("hidden")) {
        summerPeakAdjustment = 1.0;
        summerPeakAdjustmentAmount = 0;
      } else if (summerPeakAdjustmentMode === "percentage") {
        summerPeakAdjustment = parseFloat(document.getElementById("summerPeakAdjustment")?.value || 1.0);
      } else {
        const wan = parseInt(document.getElementById("summerPeakAdjustment_wan")?.value || 0);
        const qian = parseInt(document.getElementById("summerPeakAdjustment_qian")?.value || 0);
        const bai = parseInt(document.getElementById("summerPeakAdjustment_bai")?.value || 0);
        summerPeakAdjustmentAmount = wan * 10000 + qian * 1000 + bai * 100;
        applySummerPeakAdjustmentAmount = summerPeakAdjustmentAmount > 0;
      }

      let springFestivalAdjustment = 1.0;
      let springFestivalAdjustmentAmount = 0;
      let applySpringFestivalAdjustmentAmount = false;
      if (document.getElementById("springFestivalAdjustmentSection")?.classList.contains("hidden")) {
        springFestivalAdjustment = 1.0;
        springFestivalAdjustmentAmount = 0;
      } else if (springFestivalAdjustmentMode === "percentage") {
        springFestivalAdjustment = parseFloat(document.getElementById("springFestivalAdjustment")?.value || 1.0);
      } else {
        const wan = parseInt(document.getElementById("springFestivalAdjustment_wan")?.value || 0);
        const qian = parseInt(document.getElementById("springFestivalAdjustment_qian")?.value || 0);
        const bai = parseInt(document.getElementById("springFestivalAdjustment_bai")?.value || 0);
        springFestivalAdjustmentAmount = wan * 10000 + qian * 1000 + bai * 100;
        applySpringFestivalAdjustmentAmount = springFestivalAdjustmentAmount > 0;
      }

      if (!checkIn || !checkOut || checkOut <= checkIn || !roomType) return { total: 0, breakdown: [], addBreakfast: 0 };

      let totalPrice = 0;
      let currentDate = new Date(checkIn);
      let nightCount = 0;
      let breakdown = [];

      while (currentDate < checkOut) {
        nightCount++;
        let price;
        let basePrice;
        let nightType;
        const dateStr = currentDate.toISOString().split('T')[0];
        let nightDiscount = 1.0;
        let integerPrice = 0;
        let useIntegerMode = false;

        const nightModeElement = document.getElementById(`discountModeNight${nightCount}`);
        const nightMode = discountMode === "mixed" && nightModeElement ? nightModeElement.value : discountMode;
        if (nightMode === "percentage") {
          nightDiscount = parseFloat(document.getElementById(`discountNight${nightCount}`)?.value || 1.0);
        } else {
          const wan = parseInt(document.getElementById(`discountNight${nightCount}_wan`)?.value || 0);
          const qian = parseInt(document.getElementById(`discountNight${nightCount}_qian`)?.value || 0);
          const bai = parseInt(document.getElementById(`discountNight${nightCount}_bai`)?.value || 0);
          integerPrice = wan * 10000 + qian * 1000 + bai * 100;
          useIntegerMode = integerPrice > 0;
        }

        if (dayTypeMode === "auto") {
          const isHolidayNight = isHoliday(currentDate);
          nightType = isHolidayNight ? (isNationalHoliday(currentDate) ? "nationalHoliday" : "holiday") : "weekday";
        } else {
          nightType = document.getElementById(`nightType${nightCount}`)?.value || "weekday";
        }

        const isPeakSeason = isSummerPeakSeason(currentDate);
        const isSpringFestivalEveToThird = isSpringFestivalEveToThirdDay(currentDate);

        if (useIntegerMode) {
          price = integerPrice;
        } else {
          if (isSpringFestivalEveToThird) {
            basePrice = 36800;
            price = applySpringFestivalAdjustmentAmount ? basePrice + springFestivalAdjustmentAmount : basePrice * springFestivalAdjustment;
          } else if (nightType === "nationalHoliday" && isSpringFestival(currentDate)) {
            basePrice = 36800;
            price = applySpringFestivalAdjustmentAmount ? basePrice + springFestivalAdjustmentAmount : basePrice * springFestivalAdjustment;
          } else if (nightType === "holiday" || nightType === "nationalHoliday") {
            basePrice = 27800;
            if (isPeakSeason) {
              price = applySummerPeakAdjustmentAmount ? basePrice + summerPeakAdjustmentAmount : basePrice * summerPeakAdjustment;
            } else {
              price = basePrice;
            }
          } else {
            basePrice = basePrices[roomType]?.weekday || 0;
            if (isPeakSeason) {
              price = applySummerPeakAdjustmentAmount ? basePrice + summerPeakAdjustmentAmount : basePrice * summerPeakAdjustment;
            } else {
              price = basePrice;
            }
          }
          price = price * nightDiscount;
        }

        totalPrice += price;
        breakdown.push({ 
          date: dateStr, 
          price: price, 
          type: nightType === "weekday" ? `平日(${dayNames[currentDate.getDay()]})` : nightType === "holiday" ? `假日(${dayNames[currentDate.getDay()]})` : `國定假日(${dayNames[currentDate.getDay()]})`, 
          night: nightCount, 
          discount: nightDiscount,
          integerPrice: integerPrice,
          useIntegerMode: useIntegerMode,
          isPeakSeason: isPeakSeason,
          summerPeakAdjustment: summerPeakAdjustment,
          summerPeakAdjustmentAmount: summerPeakAdjustmentAmount,
          applySummerPeakAdjustmentAmount: applySummerPeakAdjustmentAmount,
          isSpringFestivalEveToThird: isSpringFestivalEveToThird,
          springFestivalAdjustment: springFestivalAdjustment,
          springFestivalAdjustmentAmount: springFestivalAdjustmentAmount,
          applySpringFestivalAdjustmentAmount: applySpringFestivalAdjustmentAmount
        });
        currentDate.setDate(currentDate.getDate() + 1);
      }

      const numNights = calculateNights();
      const breakfastCost = addBreakfast * 1000 * numNights;
      const finalTotal = (totalPrice + breakfastCost) * totalDiscount;
      return { 
        total: finalTotal, 
        breakdown: breakdown, 
        addBreakfast: addBreakfast,
        summerPeakAdjustment: summerPeakAdjustment,
        summerPeakAdjustmentAmount: summerPeakAdjustmentAmount,
        applySummerPeakAdjustmentAmount: applySummerPeakAdjustmentAmount,
        springFestivalAdjustment: springFestivalAdjustment,
        springFestivalAdjustmentAmount: springFestivalAdjustmentAmount,
        applySpringFestivalAdjustmentAmount: applySpringFestivalAdjustmentAmount
      };
    }

    function updatePrice() {
      const result = calculatePricePerNight();
      if (result.total > 0) {
        document.getElementById("quoteTotal").textContent = Math.round(result.total).toLocaleString();
        document.getElementById("quoteDeposit").textContent = Math.round(result.total * 0.5).toLocaleString();
        document.getElementById("quoteResult").classList.remove("hidden");
      } else {
        document.getElementById("quoteResult").classList.add("hidden");
      }
      return result.total;
    }

    function generateQuote() {
      const checkInDate = document.getElementById("checkInDate").value;
      const checkOutDate = document.getElementById("checkOutDate").value;
      const roomType = document.getElementById("roomType").value;
      if (!checkInDate || !checkOutDate) {
        alert("請選擇入住和退房日期！");
        return;
      }
      if (new Date(checkOutDate) <= new Date(checkInDate)) {
        alert("退房日期必須晚於入住日期！");
        return;
      }
      if (!roomType) {
        alert("請選擇房型！");
        return;
      }

      const numNights = calculateNights();
      const addBreakfast = parseInt(document.getElementById("addBreakfast").value);
      const totalDiscount = parseFloat(document.getElementById("totalDiscount")?.value || 1.0);
      const { total, breakdown, summerPeakAdjustment, summerPeakAdjustmentAmount, applySummerPeakAdjustmentAmount, springFestivalAdjustment, springFestivalAdjustmentAmount, applySpringFestivalAdjustmentAmount } = calculatePricePerNight();

      let dayTypeText = "";
      breakdown.forEach(item => {
        dayTypeText += `第${item.night}晚：${item.type}`;
        if (item.night < numNights) dayTypeText += "，";
      });

      const numPeople = basePrices[roomType]?.people || 0;
      const totalDiscountText = totalDiscount === 1.0 ? "無折扣" : totalDiscount === 0.9 ? "9折" : totalDiscount === 0.8 ? "8折" : `${(totalDiscount * 100)}折`;
      const summerPeakAdjustmentText = applySummerPeakAdjustmentAmount ? `NT$ ${summerPeakAdjustmentAmount.toLocaleString()} (加價金額)` : summerPeakAdjustment === 1.0 ? "無調漲" : `調漲${Math.round((summerPeakAdjustment - 1) * 100)}%`;
      const springFestivalAdjustmentText = applySpringFestivalAdjustmentAmount ? `NT$ ${springFestivalAdjustmentAmount.toLocaleString()} (加價金額)` : springFestivalAdjustment === 1.0 ? "無調漲" : `調漲${Math.round((springFestivalAdjustment - 1) * 100)}%`;

      document.getElementById("quoteCheckInDate").textContent = checkInDate || "未選擇";
      document.getElementById("quoteCheckOutDate").textContent = checkOutDate || "未選擇";
      document.getElementById("quoteDayType").textContent = dayTypeText;
      document.getElementById("quoteRoomType").textContent = roomTypeDisplay[roomType] || roomType;
      document.getElementById("quoteNumPeople").textContent = numPeople;
      document.getElementById("quoteNumNights").textContent = numNights;

      if (applySummerPeakAdjustmentAmount || summerPeakAdjustment !== 1.0) {
        document.getElementById("quoteSummerPeakAdjustmentRow").classList.remove("hidden");
        document.getElementById("quoteSummerPeakAdjustment").textContent = summerPeakAdjustmentText;
      } else {
        document.getElementById("quoteSummerPeakAdjustmentRow").classList.add("hidden");
      }

      if (applySpringFestivalAdjustmentAmount || springFestivalAdjustment !== 1.0) {
        document.getElementById("quoteSpringFestivalAdjustmentRow").classList.remove("hidden");
        document.getElementById("quoteSpringFestivalAdjustment").textContent = springFestivalAdjustmentText;
      } else {
        document.getElementById("quoteSpringFestivalAdjustmentRow").classList.add("hidden");
      }

      let breakdownHtml = "<p><strong>每晚價格明細：</strong></p><ul>";
      breakdown.forEach(item => {
        let discountText = "";
        if (item.useIntegerMode) {
          discountText = item.integerPrice > 0 ? `(優惠價)` : "";
        } else {
          let discountDisplay;
          if (item.discount === 0.9) {
            discountDisplay = "9折價";
          } else if (item.discount === 0.8) {
            discountDisplay = "8折價";
          } else if (item.discount === 0.7) {
            discountDisplay = "7折價";
          } else if (item.discount === 0.65) {
            discountDisplay = "65折價";
          } else if (item.discount === 0.55) {
            discountDisplay = "55折價";
          } else if (item.discount === 0.5) {
            discountDisplay = "5折";
          } else if (item.discount === 1.0) {
            discountDisplay = "";
          } else {
            discountDisplay = `${(item.discount * 100)}折價`;
          }
          discountText = discountDisplay ? `(${discountDisplay})` : "";
        }
        breakdownHtml += `<li>第${item.night}晚 ${item.date} (${item.type.match(/^(.*?)\(/)[1]})：NT$ ${Math.round(item.price).toLocaleString()} ${discountText}</li>`;
      });
      breakdownHtml += "</ul>";
      document.getElementById("nightlyBreakdown").innerHTML = breakdownHtml;

      if (addBreakfast > 0) {
        document.getElementById("quoteAddBreakfastRow").classList.remove("hidden");
        document.getElementById("quoteAddBreakfast").textContent = `${(addBreakfast * 1000 * numNights).toLocaleString()}（加床數：${addBreakfast} 床）`;
      } else {
        document.getElementById("quoteAddBreakfastRow").classList.add("hidden");
      }

      if (!document.getElementById("totalDiscountSection").classList.contains("hidden") && totalDiscount !== 1.0) {
        document.getElementById("quoteTotalDiscountRow").classList.remove("hidden");
        document.getElementById("quoteTotalDiscount").textContent = totalDiscountText;
      } else {
        document.getElementById("quoteTotalDiscountRow").classList.add("hidden");
      }

      document.getElementById("quoteTotal").textContent = Math.round(total).toLocaleString();
      document.getElementById("quoteDeposit").textContent = Math.round(total * 0.5).toLocaleString();

      document.getElementById("quoteResult").classList.remove("hidden");
      document.getElementById("copyMessage").classList.add("hidden");
      document.getElementById("quoteTextArea").style.display = "none";
    }

    function copyQuote() {
      const addBreakfast = parseInt(document.getElementById("addBreakfast").value);
      let quoteText = `

入住日期：${document.getElementById("quoteCheckInDate").textContent}
退房日期：${document.getElementById("quoteCheckOutDate").textContent}
日期類型：${document.getElementById("quoteDayType").textContent}
房型：${document.getElementById("quoteRoomType").textContent}
入住人數：${document.getElementById("quoteNumPeople").textContent} 人
入住天數：${document.getElementById("quoteNumNights").textContent} 晚
      `.trim();

      if (!document.getElementById("quoteSummerPeakAdjustmentRow").classList.contains("hidden")) {
        quoteText += `\n暑假調漲：${document.getElementById("quoteSummerPeakAdjustment").textContent}`;
      }
      if (!document.getElementById("quoteSpringFestivalAdjustmentRow").classList.contains("hidden")) {
        quoteText += `\n春節調漲：${document.getElementById("quoteSpringFestivalAdjustment").textContent}`;
      }

      quoteText += `\n\n每晚價格明細：`;
      quoteText += `\n${Array.from(document.querySelectorAll("#nightlyBreakdown ul li")).map(item => "• " + item.textContent).join("\n")}`;

      if (addBreakfast > 0) {
        quoteText += `\n加床費用：NT$ ${document.getElementById("quoteAddBreakfast").textContent}`;
      }
      if (!document.getElementById("quoteTotalDiscountRow").classList.contains("hidden")) {
        quoteText += `\n總價折扣：${document.getElementById("quoteTotalDiscount").textContent}`;
      }
      quoteText += `\n\n總金額：NT$ ${document.getElementById("quoteTotal").textContent}；訂金(50%)：NT$ ${document.getElementById("quoteDeposit").textContent}`;

      const copyMessage = document.getElementById("copyMessage");
      const textArea = document.getElementById("quoteTextArea");

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(quoteText).then(() => {
          copyMessage.textContent = "報價單內容已複製！";
          copyMessage.style.color = "green";
          copyMessage.classList.remove("hidden");
          textArea.style.display = "none";
          setTimeout(() => copyMessage.classList.add("hidden"), 2000);
        }).catch(err => {
          textArea.value = quoteText;
          textArea.style.display = "block";
          copyMessage.textContent = "複製失敗，請從下方選取並手動複製！（建議使用最新版本的 Chrome、Firefox 或 Safari）";
          copyMessage.style.color = "red";
          copyMessage.classList.remove("hidden");
          setTimeout(() => copyMessage.classList.add("hidden"), 3000);
        });
      } else {
        textArea.value = quoteText;
        textArea.style.display = "block";
        copyMessage.textContent = "您的瀏覽器不支援自動複製，請從下方選取並手動複製！（建議使用最新版本的 Chrome、Firefox 或 Safari）";
        copyMessage.style.color = "red";
        copyMessage.classList.remove("hidden");
        setTimeout(() => copyMessage.classList.add("hidden"), 3000);
      }
    }

    document.getElementById("checkInDate").setAttribute("min", new Date().toISOString().split('T')[0]);
    document.getElementById("checkOutDate").setAttribute("min", new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0]);
  </script>
</body>
</html>
